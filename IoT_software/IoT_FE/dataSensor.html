<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Data Sensor</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    /* ========== STYLE (gi·ªØ nguy√™n √Ω t∆∞·ªüng g·ªëc) ========== */
    body { background: #f4f6f9; } /* n·ªÅn */
    .table-hover tbody tr:hover { background-color: #eaf4ff; } /* hover h√†ng */
    .pagination .page-link { border-radius: 8px !important; margin: 0 2px; } /* style ph√¢n trang */
    .pagination .page-item.active .page-link { background: #3498db; border-color: #3498db; } /* active page */
    .pagination-info { background: #fff; padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 8px; } /* info box */
    th.sortable { cursor: pointer; user-select: none; } /* c√≥ th·ªÉ sort (n·∫øu c·∫ßn) */

    /* style cho n√∫t sort (g·ªëc) */
    .sort-btn {
      background: none; color: #fff; border: none; cursor: pointer; font-size: 20px; margin-left: 4px;
      vertical-align: middle; padding: 0;
    }
    .sort-btn:hover { color: #ccc; }
  </style>
</head>
<body>

  <!-- ========== 1. NAVBAR + HEADER ========== -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary"> <!-- thanh ƒëi·ªÅu h∆∞·ªõng -->
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="index.html"><i class="fa-solid fa-microchip"></i> IoT CONTROL</a>
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link active" href="dataSensor.html">Data Sensor</a></li>
        <li class="nav-item"><a class="nav-link" href="actionHistory.html">Action History</a></li>
        <li class="nav-item"><a class="nav-link" href="profile.html">Profile</a></li>
      </ul>
      <div class="d-flex align-items-center ms-3">
        <span class="fw-bold text-white me-2">Ph√πng B√° Huy</span> <!-- t√™n hi·ªÉn th·ªã -->
        <img src="https://i.pinimg.com/1200x/08/de/cf/08decf273c35ee596e00188ec3d6d341.jpg" class="rounded-circle" width="35" height="35"> <!-- avatar -->
      </div>
    </div>
  </nav>

  <!-- ========== 2. FILTERS (UI) ========== -->
  <div class="container py-4">
    <h3 class="fw-bold"><i class="fa-solid fa-database"></i> Data Sensor</h3>

    <div class="d-flex gap-2 mb-3 align-items-center"> <!-- v√πng filter -->
      <select id="filter-type" class="form-select w-auto"> <!-- ch·ªçn lo·∫°i sensor -->
        <option value="all">T·∫•t c·∫£</option>
        <option value="temp">Nhi·ªát ƒë·ªô</option>
        <option value="hum">ƒê·ªô ·∫©m</option>
        <option value="light">√Ånh s√°ng</option>
      </select>

      <input type="text" id="search-text" class="form-control w-25" placeholder="T√¨m ki·∫øm..."> <!-- √¥ t√¨m ki·∫øm -->

      <button id="search-btn" class="btn btn-primary">T√¨m ki·∫øm</button> <!-- n√∫t t√¨m -->
    </div>

    <!-- ========== 3. TABLE ========== -->
    <div class="card">
      <div class="card-body p-0">
        <table class="table table-striped table-hover mb-0">
          <thead id="table-header" class="table-dark"></thead> <!-- header build b·∫±ng JS -->
          <tbody id="data-body"></tbody> <!-- body build b·∫±ng JS -->
        </table>
      </div>
    </div>

    <!-- ========== 4. PAGINATION UI ========== -->
<div class="d-flex justify-content-between align-items-center mt-4">
  <!-- Page Limit b√™n tr√°i -->
  <div class="pagination-info" id="page-limit-box"></div>

  <!-- Ph√¢n trang ·ªü gi·ªØa -->
  <nav class="flex-grow-1 d-flex justify-content-center">
    <ul class="pagination mb-0" id="pagination"></ul>
  </nav>

  <!-- C·ªôt ph·∫£i r·ªóng ƒë·ªÉ c√¢n b·∫±ng -->
  <div style="width:200px"></div>
</div>


  </div>

<script>
// ================= 5. SCRIPT =================
 

// ========== 5.1 STATE & CONFIG ==========
let currentPage = 1;                    // trang hi·ªán t·∫°i
let totalPages = 1;                     // t·ªïng s·ªë trang (do BE tr·∫£ v·ªÅ)
let rowsPerPage = 10;                   // s·ªë h√†ng/trang (page limit)
let currentSortField = "time";          // field sort (m·∫∑c ƒë·ªãnh: time)
let currentSortOrder = "desc";          // order sort ('asc' | 'desc')

// ========== 5.2 DOM INIT (page limit selector) ==========
const pageLimitBox = document.getElementById("page-limit-box"); // box g·∫Øn selector
pageLimitBox.innerHTML = `
  Page limit:
  <select id="limit-select" class="form-select d-inline-block mx-2" style="width:auto">
    <option value="10">10</option>
    <option value="20">20</option>
    <option value="30">30</option>
    <option value="40">40</option>
    <option value="50">50</option>
  </select>
`;
document.getElementById("limit-select").value = String(rowsPerPage); // sync select v·ªõi var

document.getElementById("limit-select").addEventListener("change", (e) => {
  rowsPerPage = +e.target.value;         // update rowsPerPage
  currentPage = 1;                       // reset v·ªÅ trang 1
  fetchData();                           // l·∫•y l·∫°i d·ªØ li·ªáu
});

// ========== 5.3 fetchData: g·ªçi BE l·∫•y d·ªØ li·ªáu ==========
async function fetchData() {
  try {
    const type = document.getElementById("filter-type").value;    // lo·∫°i sensor
    const search = document.getElementById("search-text").value.trim(); // t·ª´ kh√≥a

    // x√¢y params theo BE (gi·ªØ t√™n param g·ªëc)
    const params = new URLSearchParams({
      type,
      search,
      sortField: currentSortField,
      sortOrder: currentSortOrder,
      page: currentPage,
      limit: rowsPerPage,
    });

    const res = await fetch(`http://localhost:4000/api/dataSensor?${params}`); // g·ªçi BE
    if (!res.ok) {
      console.error("L·ªói API:", res.status, await res.text()); // log l·ªói n·∫øu c√≥
      return;
    }
    const result = await res.json();
    totalPages = result.totalPages || 1;                      // l·∫•y totalPages t·ª´ BE
    totalPages = Math.max(1, totalPages);                     // ƒë·∫£m b·∫£o >=1
    renderTable(result.data || []);                           // render b·∫£ng
    renderPagination();                                       // render ph√¢n trang
  } catch (err) {
    console.error("‚ùå L·ªói load data:", err);                  // log l·ªói JS
  }
}

// ========== 5.4 renderTable: header + body ==========
function renderTable(data) {
  const headerRow = document.getElementById("table-header");
  const tbody = document.getElementById("data-body");
  tbody.innerHTML = "";                                       // clear body

  const filterType = document.getElementById("filter-type").value; // hi·ªán t·∫°i filter type
  const colLabels = { temp: "üå°Ô∏è Nhi·ªát ƒë·ªô (¬∞C)", hum: "üíß ƒê·ªô ·∫©m (%)", light: "‚òÄÔ∏è √Ånh s√°ng (lux)" };

  let cols = [];
  if (filterType === "all") cols = ["temp", "hum", "light"];  // t·∫•t c·∫£ c·ªôt
  else cols = [filterType];                                   // ho·∫∑c 1 c·ªôt

  // x√¢y header (bao g·ªìm n√∫t sort dropdown) - time kh√¥ng sort ·ªü header g·ªëc
  let headerHtml = "<tr><th>#</th>";
  cols.forEach(c => {
    const active = currentSortField === c;                    // c ƒëang active sort?
    const label = colLabels[c];
    headerHtml += `
      <th>
        ${label}
        <div class="dropdown d-inline">
          <button class="sort-btn dropdown-toggle ms-1" data-bs-toggle="dropdown" aria-expanded="false">
            ${active ? (currentSortOrder === "asc" ? '‚Üë' : '‚Üì') : ""}
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="changeSort('${c}', '')">--</a></li>
            <li><a class="dropdown-item" href="#" onclick="changeSort('${c}', 'desc')">‚Üì</a></li>
            <li><a class="dropdown-item" href="#" onclick="changeSort('${c}', 'asc')">‚Üë</a></li>
          </ul>
        </div>
      </th>`;                                               // gi·ªØ UI sort nh∆∞ g·ªëc
  });
  headerHtml += `<th>‚è± Th·ªùi gian</th>`;                        // c·ªôt time (kh√¥ng sort)
  headerHtml += "</tr>";
  headerRow.innerHTML = headerHtml;                            // g·∫Øn header

  // render body rows
  if (!data || data.length === 0) {
    tbody.innerHTML = `<tr><td colspan="${cols.length + 2}" class="text-center small">Kh√¥ng c√≥ d·ªØ li·ªáu ph√π h·ª£p</td></tr>`; // no data
    return;
  }

  data.forEach(rec => {
    let row = `<td>${rec.id}</td>`;                            // id (t·ª´ BE)
    cols.forEach(col => {
      row += `<td>${rec[col] ?? "-"}</td>`;                    // gi√° tr·ªã c·ªôt (or "-")
    });
    row += `<td>${rec.time ? formatDateDisplay(new Date(rec.time)) : "-"}</td>`; // format th·ªùi gian
    tbody.innerHTML += `<tr>${row}</tr>`;
  });
}

// ========== 5.5 renderPagination ==========
function renderPagination() {
  const page = currentPage;
  const total = totalPages;

  const pagination = document.getElementById("pagination");
  if (!pagination) return;
  let html = "";

  // Prev button
  html += `<li class="page-item ${page === 1 ? "disabled" : ""}">
             <a class="page-link" href="#" onclick="goToPage(${page - 1});return false;">&laquo;</a>
           </li>`;

  // helper nh·ªè: tr·∫£ v·ªÅ html cho 1 n√∫t trang
  const pageItem = (p) => `<li class="page-item ${p === page ? "active" : ""}">
                             <a class="page-link" href="#" onclick="goToPage(${p});return false;">${p}</a>
                           </li>`;

  if (total <= 7) {
    // n·∫øu √≠t trang th√¨ hi·ªÉn th·ªã h·∫øt
    for (let p = 1; p <= total; p++) html += pageItem(p);
  } else {
    // lu√¥n hi·ªán trang 1
    html += pageItem(1);

    const left = page - 2;
    const right = page + 2;

    // ch√®n "..." n·∫øu c·∫ßn tr∆∞·ªõc v√πng gi·ªØa
    if (left > 2) {
      html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
    }

    // v√πng c√°c trang quanh currentPage
    const start = Math.max(2, left);
    const end = Math.min(total - 1, right);
    for (let p = start; p <= end; p++) html += pageItem(p);

    // ch√®n "..." n·∫øu c·∫ßn sau v√πng gi·ªØa
    if (end < total - 1) {
      html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
    }

    // lu√¥n hi·ªán trang cu·ªëi
    html += pageItem(total);
  }

  // Next button
  html += `<li class="page-item ${page === total ? "disabled" : ""}">
             <a class="page-link" href="#" onclick="goToPage(${page + 1});return false;">&raquo;</a>
           </li>`;

  pagination.innerHTML = html;
}


// ========== 5.6 HELPERS ==========
function formatDateDisplay(d) {                                 // format Date -> dd/mm/yy hh:mm:ss
  const dd = String(d.getDate()).padStart(2, "0");
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const yy = String(d.getFullYear()).slice(-2);
  const hh = String(d.getHours()).padStart(2, "0");
  const min = String(d.getMinutes()).padStart(2, "0");
  const ss = String(d.getSeconds()).padStart(2, "0");
  return `${dd}/${mm}/${yy} ${hh}:${min}:${ss}`;
}

function goToPage(p) {                                          // chuy·ªÉn trang an to√†n
  if (p >= 1 && p <= totalPages) {
    currentPage = p;
    fetchData();
  }
}

function changeSort(field, order) {                              // change sort t·ª´ dropdown
  if (order === "") {
    currentSortField = "time";                                  // reset v·ªÅ default theo time
    currentSortOrder = "desc";
  } else {
    currentSortField = field;
    currentSortOrder = order;
  }
  currentPage = 1;
  fetchData();
}

// ========== 5.7 EVENTS BINDING ==========
document.getElementById("search-btn").addEventListener("click", () => { currentPage = 1; fetchData(); }); // b·∫•m t√¨m
document.getElementById("search-text").addEventListener("keydown", (e) => { if (e.key === "Enter") { e.preventDefault(); currentPage = 1; fetchData(); }}); // enter t√¨m
document.getElementById("filter-type").addEventListener("change", () => { currentPage = 1; fetchData(); }); // ƒë·ªïi lo·∫°i sensor

// ========== 5.8 INITIAL LOAD ==========
fetchData();                                                    // load l·∫ßn ƒë·∫ßu khi m·ªü trang
</script>

<!-- Bootstrap JS (bundle c√≥ c·∫£ Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
