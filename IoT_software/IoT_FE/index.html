<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>IoT Dashboard</title>


  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* --- To√†n trang --- */
    body { background-color: #f4f6f9; overflow: hidden; transform: scale(0.9); transform-origin: top left; width: 111%; height: 111%; }
    .navbar { box-shadow: 0 2px 6px rgba(0,0,0,0.3); }

    /* Card t·ªïng (th·ªÉ hi·ªán 3 c·∫£m bi·∫øn: nhi·ªát, ·∫©m, √°nh s√°ng) */
    .card { border: none; border-radius: 15px; box-shadow: 0 6px 15px rgba(0,0,0,0.3); }
    .card.temp { background: #ff7675; color: white; }       /* √¥ nhi·ªát ƒë·ªô */
    .card.humidity { background: #74b9ff; color: white; }   /* √¥ ƒë·ªô ·∫©m */
    .card.light { background: #ffeaa7; color: #2d3436; }    /* √¥ √°nh s√°ng */

    /* Card cho bi·ªÉu ƒë·ªì */
    .chart-card {
      border-radius: 15px;
      background: #ffffff;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
    }

    /* Thi·∫øt k·∫ø √¥ thi·∫øt b·ªã (b√™n ph·∫£i) */
    .device-card {
      background: #f8f9fa;
      border-radius: 15px;
      height: 143px;
      padding: 15px;
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 16px;
      box-shadow: 0 6px 15px rgba(0,0,0,0.12);
      transition: opacity 0.3s ease;
    }
    .device-card i { font-size: 40px; }
    .device-card span { font-weight: bold; font-size: 20px; }

    /* N√∫t b·∫•m */
    .btn { padding: 6px 15px; border-radius: 20px; font-size: 14px; font-weight: 600; }
    .inactive { opacity: 0.45; } /* class d√πng ƒë·ªÉ l√†m m·ªù n√∫t/hi·ªán tr·∫°ng kh√¥ng ho·∫°t ƒë·ªông */

    /* üî• Hi·ªáu ·ª©ng icon c·ªßa thi·∫øt b·ªã */
    /* Qu·∫°t: th√™m class .spin s·∫Ω quay icon li√™n t·ª•c */
    .fa-fan.spin { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* ƒê√®n: class .on l√†m s√°ng v√† glow */
    .fa-lightbulb.on { color: #f1c40f; text-shadow: 0 0 15px #f39c12; }

    /* ƒêi·ªÅu h√≤a: hi·ªáu ·ª©ng "th·ªïi" */
    .fa-snowflake.blow {
      animation: blow 0.5s ease-in-out infinite alternate;
      color: #00cec9;
    }
    @keyframes blow { from { transform: translateX(0); } to { transform: translateX(5px); } }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <!-- Logo / brand -->
      <a class="navbar-brand fw-bold" href="index.html"><i class="fa-solid fa-microchip"></i> IoT CONTROL</a>

      <!-- Menu ƒëi·ªÅu h∆∞·ªõng -->
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link active" href="index.html">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="dataSensor.html">Data Sensor</a></li>
        <li class="nav-item"><a class="nav-link" href="actionHistory.html">Action History</a></li>
        <li class="nav-item"><a class="nav-link" href="profile.html">Profile</a></li>
      </ul>

      <!-- Th√¥ng tin ng∆∞·ªùi d√πng (t√™n + avatar) -->
      <div class="d-flex align-items-center ms-3">
        <span class="fw-bold text-white me-2">Ph√πng B√° Huy</span>
        <img src="https://i.pinimg.com/1200x/08/de/cf/08decf273c35ee596e00188ec3d6d341.jpg"
             class="rounded-circle" width="35" height="35" alt="Avatar">
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <!-- Ti√™u ƒë·ªÅ trang -->
    <h2 class="mb-4 fw-bold"><i class="fa-solid fa-gauge-high"></i> Dashboard</h2>

      <!-- 3 √¥ hi·ªÉn th·ªã c·∫£m bi·∫øn (Nhi·ªát ƒë·ªô, ƒê·ªô ·∫©m, √Ånh s√°ng) -->
      <!-- M·ªói √¥ c√≥ id ri√™ng: temp, humidity, light -> ƒë∆∞·ª£c JS c·∫≠p nh·∫≠t gi√° tr·ªã realtime -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="card temp text-center p-3">
            <i class="fa-solid fa-temperature-high"></i>
            <h5>Nhi·ªát ƒë·ªô</h5>
            <p id="temp" class="fs-3 fw-bold">-- ¬∞C</p> <!-- gi√° tr·ªã s·∫Ω thay ƒë·ªïi b·∫±ng JS -->
          </div>
        </div>
        <div class="col-md-4">
          <div class="card humidity text-center p-3">
            <i class="fa-solid fa-droplet"></i>
            <h5>ƒê·ªô ·∫©m</h5>
            <p id="humidity" class="fs-3 fw-bold">-- %</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card light text-center p-3">
            <i class="fa-solid fa-sun"></i>
            <h5>√Ånh s√°ng</h5>
            <p id="light" class="fs-3 fw-bold">-- lux</p>
          </div>
        </div>
      </div>

      <!-- Bi·ªÉu ƒë·ªì + Danh s√°ch thi·∫øt b·ªã -->
      <div class="row">
        <!-- Bi·ªÉu ƒë·ªì l·ªõn chi·∫øm 8 c·ªôt -->
        <div class="col-md-8">
          <div class="card chart-card p-3">
            <h6 class="fw-bold mb-2"><i class="fa-solid fa-chart-line"></i> Bi·ªÉu ƒë·ªì c·∫£m bi·∫øn</h6>
            <canvas id="sensorChart" height="400"></canvas> <!-- Chart.js v·∫Ω v√†o ƒë√¢y -->
          </div>
        </div>

        <!-- Danh s√°ch thi·∫øt b·ªã (s·∫Ω render b·∫±ng JS v√†o div #device-list) -->
        <div class="col-md-4">
          <div id="device-list"></div>
        </div>
      </div>
    </div>

    <!-- C√°c tab pane (hi·ªán ƒëang l√† content placeholder) -->
    <!-- L∆∞u √Ω: hi·ªán c√°c tab n√†y kh√¥ng ƒë∆∞·ª£c Bootstrap k√≠ch ho·∫°t (ch·ªâ l√† container n·ªôi dung) -->
    <div class="tab-pane fade" id="datasensor">
      <h3>üìä Data Sensor</h3>
      <div id="sensor-table">B·∫£ng Data Sensor s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</div>
    </div>

    <div class="tab-pane fade" id="actionhistory">
      <h3>üìú Action History</h3>
      <div id="action-table">B·∫£ng Action History s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</div>
    </div>

    <div class="tab-pane fade" id="profile">
      <h3>üë§ Profile</h3>
      <p>Th√¥ng tin ng∆∞·ªùi d√πng...</p>
    </div>
  </div>

  <!-- ------------------ SCRIPT CH√çNH (JS) ------------------ -->
  <script>
  // ƒê∆∞·ªùng d·∫´n g·ªëc ƒë·∫øn API backend (Node.js) - thay ƒë·ªïi n·∫øu server deploy ·ªü n∆°i kh√°c
  const API_ROOT = "http://localhost:4000"; // server Node.js

  // Danh s√°ch thi·∫øt b·ªã m√† UI s·∫Ω hi·ªÉn th·ªã v√† ƒëi·ªÅu khi·ªÉn
  // M·ªói object c√≥: key (kh·ªõp v·ªõi API/backend), label (t√™n hi·ªÉn th·ªã), icon (FontAwesome), effect (class hi·ªáu ·ª©ng)
  const devices = [
    { key: "dieuhoa", label: "ƒêi·ªÅu h√≤a", icon: "fa-snowflake", effect: "blow" },
    { key: "quat",    label: "Qu·∫°t",     icon: "fa-fan",       effect: "spin" },
    { key: "den",     label: "ƒê√®n",      icon: "fa-lightbulb", effect: "on" }
  ];

  // H√†m render danh s√°ch thi·∫øt b·ªã v√†o #device-list
  // T·∫°o HTML cho m·ªói thi·∫øt b·ªã: icon, tr·∫°ng th√°i, n√∫t ON/OFF
  function renderDevices() {
    document.getElementById("device-list").innerHTML = devices.map(d => `
      <div class="device-card" id="card-${d.key}">
        <div>
          <i class="fa-solid ${d.icon} me-2"></i>
          <span id="status-${d.key}">OFF</span>
          <div class="small text-muted">${d.label}</div>
        </div>
        <div>
          <button class="btn btn-success inactive me-1" data-device="${d.key}" data-action="ON">ON</button>
          <button class="btn btn-danger" data-device="${d.key}" data-action="OFF">OFF</button>
        </div>
      </div>
    `).join("");

    // G·∫Øn s·ª± ki·ªán click cho t·∫•t c·∫£ n√∫t ON/OFF v·ª´a render
    document.querySelectorAll("#device-list button").forEach(btn => {
      btn.addEventListener("click", () => controlDevice(btn.dataset.device, btn.dataset.action));
    });
  }

  // Wrapper fetch -> tr·∫£ v·ªÅ JSON, n√©m l·ªói khi status kh√¥ng ok
  async function fetchJson(url, opts={}) {
    const res = await fetch(url, opts);
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  // L·∫•y d·ªØ li·ªáu c·∫£m bi·∫øn t·ª´ API v√† c·∫≠p nh·∫≠t giao di·ªán + bi·ªÉu ƒë·ªì
  async function updateSensorData() {
    try {
      // G·ªçi API l·∫•y l·ªãch s·ª≠ d·ªØ li·ªáu c·∫£m bi·∫øn
      const history = await fetchJson(`${API_ROOT}/api/dataSensor/latest`);

      // N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu th√¨ d·ª´ng
      if (!Array.isArray(history) || history.length === 0) return;

      // L·∫•y ph·∫ßn t·ª≠ m·ªõi nh·∫•t (index 0 trong ƒë·ªãnh d·∫°ng API gi·∫£ s·ª≠ tr·∫£ v·ªÅ theo th·ª© t·ª± gi·∫£m d·∫ßn)
      const latest = history[0];

      // C·∫≠p nh·∫≠t 3 √¥ hi·ªÉn th·ªã nhanh
      document.getElementById("temp").innerText = (latest.temp ?? "--") + " ¬∞C";
      document.getElementById("humidity").innerText = (latest.hum ?? "--") + " %";
      document.getElementById("light").innerText = (latest.light ?? "--") + " lux";
      
      if (latest.tempColor)     document.querySelector(".card.temp").style.background = latest.tempColor;
      if (latest.humColor)      document.querySelector(".card.humidity").style.background = latest.humColor;
      if (latest.lightColor)    document.querySelector(".card.light").style.background = latest.lightColor;
      // L·∫•y 10 b·∫£n ghi g·∫ßn nh·∫•t ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì (ch√∫ √Ω ƒë·∫£o l·∫°i ƒë·ªÉ th·ªùi gian tƒÉng d·∫ßn tr√™n tr·ª•c X)
      const recent = history.slice(0, 10).reverse();

      // labels: ƒë·ªãnh d·∫°ng th·ªùi gian theo locale vi-VN, ch·ªâ hi·ªÉn th·ªã gi·ªù:ph√∫t
      sensorChart.data.labels = recent.map(d =>
        new Date(d.time).toLocaleString("vi-VN",{hour:"2-digit",minute:"2-digit"})
      );

      // datasets: l·∫ßn l∆∞·ª£t nhi·ªát ƒë·ªô, ƒë·ªô ·∫©m, √°nh s√°ng
      sensorChart.data.datasets[0].data = recent.map(d => d.temp);
      sensorChart.data.datasets[1].data = recent.map(d => d.hum);
      sensorChart.data.datasets[2].data = recent.map(d => d.light);

      // C·∫≠p nh·∫≠t Chart.js
      sensorChart.update();
    } catch (err) { 
      // L·ªói khi g·ªçi API (in ra console ƒë·ªÉ debug)
      console.error("‚ùå Sensor error:", err); 
    }
  }

  // L·∫•y tr·∫°ng th√°i ON/OFF hi·ªán t·∫°i c·ªßa c√°c thi·∫øt b·ªã t·ª´ backend
  async function fetchStatuses() {
    try {
      const data = await fetchJson(`${API_ROOT}/api/control/status`);
      updateDeviceUI(data);
    } catch (err) { console.error("‚ùå Status error:", err); }
  }

  // C·∫≠p nh·∫≠t giao di·ªán thi·∫øt b·ªã d·ª±a tr√™n object tr·∫°ng th√°i do fetchStatuses tr·∫£ v·ªÅ
  // Format gi·∫£ s·ª≠: { dieuhoa: { state: "ON" }, quat: { state: "OFF" }, ... }
  function updateDeviceUI(obj) {
    devices.forEach(d => {
      const info = obj[d.key];                      // tr·∫°ng th√°i thi·∫øt b·ªã t·ª´ backend
      const card = document.getElementById("card-"+d.key);
      const statusEl = card.querySelector("span");  // span hi·ªÉn th·ªã ON/OFF
      const icon = card.querySelector("i");         // icon ƒë·ªÉ th√™m/remove hi·ªáu ·ª©ng
      const [btnOn, btnOff] = card.querySelectorAll("button");

      if (info?.state?.toUpperCase() === "ON") {
        // N·∫øu ON: c·∫≠p nh·∫≠t ch·ªØ, disable tr·∫°ng th√°i OFF (m·ªù n√∫t OFF), b·∫≠t hi·ªáu ·ª©ng icon
        statusEl.innerText = "ON";
        btnOn.classList.remove("inactive"); btnOff.classList.add("inactive");
        icon.classList.add(d.effect); // th√™m class effect (spin/on/blow)
      } else {
        // N·∫øu OFF: ng∆∞·ª£c l·∫°i
        statusEl.innerText = "OFF";
        btnOff.classList.remove("inactive"); btnOn.classList.add("inactive");
        icon.classList.remove(d.effect);
      }
    });
  }

  // G·ª≠i l·ªánh ƒëi·ªÅu khi·ªÉn thi·∫øt b·ªã l√™n server
  // device: key (vd "quat"), action: "ON" ho·∫∑c "OFF"
  async function controlDevice(device, action) {
    try {
      await fetchJson(`${API_ROOT}/api/control`, {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({device, action})
      });
      // G·ªçi l·∫°i fetchStatuses ƒë·ªÉ l√†m UI ƒë·ªìng b·ªô v·ªõi server (ho·∫∑c server c√≥ th·ªÉ tr·∫£ tr·∫°ng th√°i m·ªõi)
      fetchStatuses();
    } catch { 
      // N·∫øu l·ªói: c·∫£nh b√°o nh·∫π, v·∫´n g·ªçi ƒë∆∞·ª£c l√† kh√¥ng g√¢y crash nh∆∞ng c√≥ th·ªÉ thi·∫øt b·ªã ƒë√£ nh·∫≠n l·ªánh.
      console.warn("‚ö†Ô∏è L·ªánh g·ª≠i kh√¥ng ph·∫£n h·ªìi, nh∆∞ng c√≥ th·ªÉ thi·∫øt b·ªã v·∫´n nh·∫≠n ƒë∆∞·ª£c."); 
    }
  }

// --- Kh·ªüi t·∫°o Chart.js ---
const sensorChart = new Chart(document.getElementById('sensorChart').getContext('2d'), {
  type: 'line',
  data: {
    labels: [],
    datasets: [
      { 
        label:'Nhi·ªát ƒë·ªô (¬∞C)', 
        borderColor:'red', 
        yAxisID: 'y1', 
        data:[], 
        fill:false, 
        tension:0.3 
      },
      { 
        label:'ƒê·ªô ·∫©m (%)', 
        borderColor:'blue', 
        yAxisID: 'y1',
        data:[], 
        fill:false, 
        tension:0.3 
      },
      { 
        label:'√Ånh s√°ng (lux)', 
        borderColor:'orange', 
        yAxisID: 'y2',
        data:[], 
        fill:false, 
        tension:0.3 
      }
    ]
  },
  options: {
    responsive:true,
    plugins:{ legend:{ position:'top' } },
    scales:{
      x:{ title:{ display:true, text:"Th·ªùi gian" } },
      y1:{
        beginAtZero:true,
        title:{ display:true, text:"Nhi·ªát ƒë·ªô / ƒê·ªô ·∫©m" },
        position: 'left'
      },
      y2:{
        beginAtZero:true,
        title:{ display:true, text:"√Ånh s√°ng" },
        position: 'right',
        grid: { drawOnChartArea:false }
      }
    }
  }
});



  // --- Kh·ªüi ch·∫°y khi load trang ---
  renderDevices();        // render danh s√°ch thi·∫øt b·ªã
  updateSensorData();     // l·∫•y v√† hi·ªÉn th·ªã d·ªØ li·ªáu c·∫£m bi·∫øn l·∫ßn ƒë·∫ßu
  fetchStatuses();        // l·∫•y tr·∫°ng th√°i thi·∫øt b·ªã l·∫ßn ƒë·∫ßu

  // Polling: m·ªói 2 gi√¢y c·∫≠p nh·∫≠t d·ªØ li·ªáu c·∫£m bi·∫øn v√† tr·∫°ng th√°i thi·∫øt b·ªã
  setInterval(updateSensorData, 2000);
  setInterval(fetchStatuses, 2000);
  </script>
  <!-- Bootstrap JS (bundle includes Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
