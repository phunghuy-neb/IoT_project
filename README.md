bÃ¢y giá» tÃ´i sáº½ nÃ³i yÃªu cáº§u cá»§a tÃ´i vá» dá»± Ã¡n 
- hiá»‡n táº¡i á»Ÿ actionhistory Ä‘ang lÆ°u tráº¡ng thÃ¡i cá»§a cáº£ 3 thiáº¿t bá»‹ cÃ¹ng 1 lÃºc tÃ´i chá»‰ muá»‘n lÆ°u cÃ¡i nÃ o Ä‘Æ°á»£c thao tÃ¡c thÃ´i cÃ²n cÃ¡i nÃ o khÃ´ng Ä‘Æ°á»£c thao tÃ¡c thÃ¬ khÃ´ng lÆ°u láº¡i 
- khi thao tÃ¡c ON/OFF Ä‘iá»u khiá»ƒn thiáº¿t bá»‹ thÃ¬ hiá»‡n táº¡i Ä‘ang lÃ  á»Ÿ fe thao tÃ¡c lÃ  be sáº½ lÆ°u vÃ o database luÃ´n nhÆ°ng tÃ´i khÃ´ng muá»‘n nhÆ° váº­y tÃ´i chá»‰ muá»‘n lÆ°u khi mÃ  esp 32 gá»­i dá»¯ liá»‡u lÃªn be thÃ¬ má»›i lÆ°u cÃ²n xÃ³a cÃ¡i lÆ°u ngay khi thao tÃ¡c trÃªn fe Ä‘i
- tÃ´i muá»‘n luá»“ng xá»­ lÃ½ hoáº¡t Ä‘á»™ng sáº½ lÃ  thao Ã¡c on/off á»Ÿ be -> be gá»­i lá»‡nh Ä‘áº¿n mqtt -> mqtt gá»­i lá»‡nh cho esp 32 thá»±c hiá»‡n thao tÃ¡c -> esp 32 thá»±c hiá»‡n xong gá»­i láº¡i mess thÃ´ng bÃ¡o tráº¡ng thÃ¡i hiá»‡n táº¡i cá»§a thiáº¿t bá»‹ cho mqtt -> mqtt gá»­i lÃªn cho be -> be gá»­i lÃªn cho fe Ä‘á»“ng thá»i lÆ°u dá»¯ liá»‡u thay Ä‘á»•i Ä‘Ã³ vÃ o database trong khoáº£ng thá»i gian chá» tráº¡ng thÃ¡i Ä‘Æ°á»£c gá»­i lÃªn thÃ¬ á»Ÿ fe nÃºt thao tÃ¡c sáº½ cÃ³ tráº¡ng thÃ¡i xoay vÃ²ng (loading) chá»‰ cÃ³ nÃºt thao tÃ¡c hiá»ƒn thá»‹ tráº¡ng thÃ¡i loading cÃ²n nÃºt khÃ´ng thao tÃ¡c váº«n sÃ¡ng bÃ¬nh thÆ°á»ng khi mÃ  esp 32 Ä‘Ã£ gá»­i thÃ´ng bÃ¡o tráº¡ng thÃ¡i má»›i lÃªn vÃ  fe nháº­n Ä‘Æ°á»£c rá»“i thÃ¬ lÃºc Ä‘Ã³ má»›i xÃ³a tráº¡ng thÃ¡i loading vÃ  sÃ¡ng nÃºt tráº¡ng thÃ¡i má»›i lÃªn cÃ²n nÃºt tráº¡ng thÃ¡i cÅ© má» Ä‘i 
- ngay khi cáº¯m thiáº¿t bá»‹ vÃ o thÃ¬ be sáº½ gá»­i lá»‡nh tráº¡ng thÃ¡i gáº§n nháº¥t trÆ°á»›c Ä‘Ã³ trong database(actionhistory) xuá»‘ng cho mqtt mqtt gá»­i lá»‡nh cho esp 32 má»Ÿ Ä‘Ãºng vá»›i tráº¡ng thÃ¡i gáº§n nháº¥t cá»§a tá»«ng thiáº¿t bá»‹ trong database vÃ  gá»­i láº¡i thÃ´ng tin tráº¡ng thÃ¡i thiáº¿t bá»‹ lÃªn Ä‘á»ƒ fe hiá»ƒn thá»‹ Ä‘Ãºng tráº¡ng thÃ¡i trÆ°á»›c Ä‘Ã³ vÃ  trong khi chá» káº¿t ná»‘i vÃ  gá»­i dá»¯ liá»‡u lÃªn Ä‘Ã³ thÃ¬ khu vá»±c Ä‘iá»u khiá»ƒn thiáº¿t bá»‹ sáº½ pháº£i bá»‹ má» Ä‘i vÃ  khÃ´ng thao tÃ¡c Ä‘Æ°á»£c nhÆ°ng váº«n hiá»ƒn thá»‹ tráº¡ng thÃ¡i gáº§n nháº¥t 
- khi thiáº¿t bá»‹ bá»‹ rÃºt ra hoáº·c máº¥t káº¿t ná»‘i vá»›i be thÃ¬ khu vá»±c Ä‘iá»u khiá»ƒn thiáº¿t bá»‹ sáº½ pháº£i bá»‹ má» Ä‘i vÃ  khÃ´ng thao tÃ¡c Ä‘Æ°á»£c nhÆ°ng váº«n hiá»ƒn thá»‹ tráº¡ng thÃ¡i gáº§n nháº¥t khi káº¿t ná»‘i láº¡i thÃ nh cÃ´ng thÃ¬ láº¡i sÃ¡ng láº¡i vÃ  cÃ³ thá»ƒ thao tÃ¡c bÃ¬nh thÆ°á»ng
- khi áº¥n refresh trÃªn web thÃ¬ tráº¡ng thÃ¡i thiáº¿t bá»‹ cÅ©ng khÃ´ng Ä‘Æ°á»£c thay Ä‘á»•i
- Ä‘áº¥y lÃ  toÃ n bá»™ yÃªu cáº§u cá»§a tÃ´i vá» viá»‡c sá»­a láº¡i dá»± Ã¡n hÃ£y Ä‘á»c tháº­t ká»¹ tá»«ng file lÃªn cho tÃ´i hÆ°á»›ng giáº£i quyáº¿t Ä‘á»ƒ tÃ´i Ä‘á»c vÃ  hÃ£y sá»­a theo hÆ°á»›ng Ä‘Ã³ Ä‘áº£m báº£o Ä‘Ãºng vá»›i yÃªu cáº§u vÃ  khÃ´ng xáº£y ra lá»—i
- Ä‘Ã¢y lÃ  code Ä‘iá»u khiá»ƒn esp 32 :
#include <WiFi.h>
#include <PubSubClient.h>
#include <DHT.h>
#include <math.h>

// ===== WiFi =====
const char* ssid = "Neb Neee";
const char* password = "012345678";

// ===== MQTT Broker =====
const char* mqtt_server = "192.168.180.176";
const int mqtt_port = 1883;
const char* mqtt_user = "adminiot";
const char* mqtt_pass = "adminiot";

WiFiClient espClient;
PubSubClient client(espClient);

// ===== Cáº¥u hÃ¬nh chÃ¢n =====
#define DHTPIN 16
#define DHTTYPE DHT11
#define DIEUHOA 18
#define QUAT 13
#define DEN 26
#define LDR_PIN 32

DHT dht(DHTPIN, DHTTYPE);

long lastMsg = 0;

// Biáº¿n lÆ°u Ä‘á»™ phÃ¢n giáº£i ADC
const int adcBits = 12;      // máº·c Ä‘á»‹nh ESP32 = 12-bit
int adcMaxValue = 0;         // sáº½ Ä‘Æ°á»£c tÃ­nh trong setup()

// Biáº¿n lÆ°u tráº¡ng thÃ¡i thiáº¿t bá»‹
bool dieuhoa_state = false;
bool quat_state = false;
bool den_state = false;

// ===== Káº¿t ná»‘i WiFi =====
void setup_wifi() {
  delay(10);
  Serial.print("Äang káº¿t ná»‘i WiFi: ");
  Serial.println(ssid);

  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  Serial.println("\nWiFi Ä‘Ã£ káº¿t ná»‘i!");
  Serial.print("IP ESP32: ");
  Serial.println(WiFi.localIP());
}

// ===== Gá»­i pháº£n há»“i tráº¡ng thÃ¡i thiáº¿t bá»‹ =====
void sendDeviceFeedback(String device, String state) {
  String topic = "esp32/" + device;
  client.publish(topic.c_str(), state.c_str());
  Serial.printf("ğŸ“¤ Gá»­i pháº£n há»“i: %s -> %s\n", topic.c_str(), state.c_str());
  
  // Delay nhá» Ä‘á»ƒ Ä‘áº£m báº£o message Ä‘Æ°á»£c gá»­i
  delay(100);
}

// ===== Callback khi nháº­n lá»‡nh tá»« MQTT =====
void callback(char* topic, byte* payload, unsigned int length) {
  String message;
  for (int i = 0; i < length; i++) {
    message += (char)payload[i];
  }
  Serial.printf("ğŸ“© Nháº­n tá»« [%s]: %s\n", topic, message.c_str());

  // Xá»­ lÃ½ lá»‡nh Ä‘iá»u hÃ²a
  if (String(topic) == "esp32/dieuhoa") {
    bool newState = (message == "ON");
    if (dieuhoa_state != newState) {
      digitalWrite(DIEUHOA, newState ? HIGH : LOW);
      dieuhoa_state = newState;
      Serial.printf("ğŸ”§ Äiá»u hÃ²a: %s\n", newState ? "Báº¬T" : "Táº®T");
      
      // Gá»­i pháº£n há»“i sau khi thá»±c hiá»‡n
      sendDeviceFeedback("dieuhoa", message);
    }
  }
  
  // Xá»­ lÃ½ lá»‡nh quáº¡t
  if (String(topic) == "esp32/quat") {
    bool newState = (message == "ON");
    if (quat_state != newState) {
      digitalWrite(QUAT, newState ? HIGH : LOW);
      quat_state = newState;
      Serial.printf("ğŸ”§ Quáº¡t: %s\n", newState ? "Báº¬T" : "Táº®T");
      
      // Gá»­i pháº£n há»“i sau khi thá»±c hiá»‡n
      sendDeviceFeedback("quat", message);
    }
  }
  
  // Xá»­ lÃ½ lá»‡nh Ä‘Ã¨n
  if (String(topic) == "esp32/den") {
    bool newState = (message == "ON");
    if (den_state != newState) {
      digitalWrite(DEN, newState ? HIGH : LOW);
      den_state = newState;
      Serial.printf("ğŸ”§ ÄÃ¨n: %s\n", newState ? "Báº¬T" : "Táº®T");
      
      // Gá»­i pháº£n há»“i sau khi thá»±c hiá»‡n
      sendDeviceFeedback("den", message);
    }
  }
}

// ===== Káº¿t ná»‘i láº¡i MQTT náº¿u máº¥t =====
void reconnect() {
  while (!client.connected()) {
    Serial.print("Äang káº¿t ná»‘i MQTT...");
    
    // âœ… ThÃªm Last Will Testament Ä‘á»ƒ phÃ¡t hiá»‡n máº¥t káº¿t ná»‘i ngay láº­p tá»©c
    if (client.connect("ESP32Client", mqtt_user, mqtt_pass, 
                       "esp32/status", 1, true, "offline")) {
      Serial.println("OK!");
      
      // âœ… Publish tráº¡ng thÃ¡i online ngay khi káº¿t ná»‘i
      client.publish("esp32/status", "online", true);
      Serial.println("ğŸ“¤ Published status: online");
      
      // Subscribe cÃ¡c topic Ä‘iá»u khiá»ƒn
      client.subscribe("esp32/dieuhoa");
      client.subscribe("esp32/quat");
      client.subscribe("esp32/den");
      
      Serial.println("âœ… ÄÃ£ subscribe cÃ¡c topic Ä‘iá»u khiá»ƒn");
      Serial.println("ğŸ”„ Chá» backend sync tráº¡ng thÃ¡i tá»« database...");
      
      // âœ… KHÃ”NG gá»­i tráº¡ng thÃ¡i, chá» backend sync tá»« database
      
    } else {
      Serial.print("Tháº¥t báº¡i, rc=");
      Serial.print(client.state());
      Serial.println(" -> thá»­ láº¡i sau 5s");
      delay(5000);
    }
  }
}

void setup() {
  Serial.begin(115200);
  pinMode(DIEUHOA, OUTPUT);
  pinMode(QUAT, OUTPUT);
  pinMode(DEN, OUTPUT);

  // Khá»Ÿi táº¡o táº¥t cáº£ thiáº¿t bá»‹ á»Ÿ tráº¡ng thÃ¡i Táº®T
  digitalWrite(DIEUHOA, LOW);
  digitalWrite(QUAT, LOW);
  digitalWrite(DEN, LOW);

  dht.begin();
  setup_wifi();

  client.setServer(mqtt_server, mqtt_port);
  client.setCallback(callback);

  // Cáº¥u hÃ¬nh ADC
  analogReadResolution(adcBits);           
  adcMaxValue = pow(2, adcBits) - 1;       

  Serial.printf("ADC resolution: %d-bit, max value: %d\n", adcBits, adcMaxValue);
  Serial.println("ğŸš€ ESP32 IoT Controller khá»Ÿi Ä‘á»™ng thÃ nh cÃ´ng!");
}

void loop() {
  if (!client.connected()) {
    reconnect();
  }
  client.loop();

  long now = millis();
  if (now - lastMsg > 2000) {
    lastMsg = now;

    float h = dht.readHumidity();
    float t = dht.readTemperature();

    // ==== Äá»c Ã¡nh sÃ¡ng vÃ  Ä‘áº£o ngÆ°á»£c dá»±a vÃ o max ADC ====
    int rawLight = analogRead(LDR_PIN);
    int lightValue = map(rawLight, 0, adcMaxValue, adcMaxValue, 0);

    if (!isnan(h) && !isnan(t)) {
      client.publish("esp32/temperature", String(t).c_str());
      client.publish("esp32/humidity", String(h).c_str());
    }
    client.publish("esp32/light", String(lightValue).c_str());

    Serial.printf("ğŸ“Š Temp: %.2fÂ°C | Hum: %.2f%% | Light: %d\n",
                  t, h, lightValue);
  }
}
 
